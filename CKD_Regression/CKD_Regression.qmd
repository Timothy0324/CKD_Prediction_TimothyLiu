---
title: "Assignment 03 – Regressions (CKD)"
author: "Timothy Liu"
format: pdf
editor: visual
---

**Dataset & link.** This report analyzes the **UCI Chronic Kidney Disease** dataset (≈400 patients, 24 variables) containing demographics, labs, and conditions relevant to CKD. Source: <https://archive.ics.uci.edu/dataset/336/chronic+kidney+disease>

# Executive Summary

1.  The purpose of my analysis is to explore factors that predict chronic kidney disease (CKD) and related health outcomes. I ran two logistic regression and one linear regression and used one continuous variable outcome (hemoglobin levels) and one binary outcome (CKD status: “notckd” vs. “ckd”). Predictor variables included both continuous (age, blood pressure, serum creatinine) and categorical (hypertension, diabetes, coronary artery disease, anemia, CKD class) variables.

2.  The dataset was cleaned by imputing missing values using median imputation for continuous variables and mode imputation for categorical variables. Variables were then converted into appropriate numeric or factor types for regression modeling.

3.  Three regression models were run: two logistic regression models predicting CKD status, and one linear regression model predicting hemoglobin levels.

4.  The tables and visualizations below showcase the regression outputs. These include coefficient tables, residual plots, ROC curves for logistic models, and coefficient plots with confidence intervals for easier interpretation.

5.  Results show that **serum creatinine (Beta = 4.15, p \< 0.001)** and **hemoglobin (Beta = –1.55, p \< 0.001)** are the strongest predictors of CKD in Logistic Model 1, with higher creatinine increasing the odds of CKD and lower hemoglobin strongly associated with CKD. Blood pressure also showed a moderate positive effect (**Beta = 0.06, p \< 0.01**). Logistic Model 1 achieved a pseudo-R² of 0.77 and ROC-AUC of 0.98, indicating excellent predictive power.\

    In Logistic Model 2, none of the comorbidity variables (hypertension, diabetes, CAD, anemia) had statistically significant betas, consistent with weaker overall predictive performance (pseudo-R² = 0.52, ROC-AUC = 0.88).\

    Finally, in the linear regression model predicting hemoglobin, **CKD status (Beta = –3.23, p \< 0.001)** and **hypertension (Beta = –1.43, p \< 0.001)** were significant negative predictors, while age and blood pressure had smaller, non-significant effects. The adjusted R² of 0.56 suggests a moderately strong model fit.

```{r}
library(dplyr)
library(ggplot2)
library(forcats)
```

```{r}
ckd_raw <- read.csv("chronic_kidney_disease.csv",
                    na.strings = c("?", "", "NA"))

glimpse(ckd_raw)
summary(ckd_raw)

```

```{r}
# define column names (26 expected + 1 "extra")
col_names <- c("id","age","bp","sg","al","su","rbc","pc","pcc","ba","bgr","bu",
               "sc","sod","pot","hemo","pcv","wbcc","rbcc","htn","dm","cad",
               "appet","pe","ane","class","extra")

ckd_raw <- read.csv("chronic_kidney_disease.csv",
                    header = TRUE, na.strings = c("?", "", "NA"),
                    col.names = col_names, fill = TRUE)

# drop the "extra" column
ckd_raw <- ckd_raw %>% select(-extra)

glimpse(ckd_raw)
```

```{r}
# numeric variables
num_cols <- c("age","bp","sg","al","su","bgr","bu","sc",
              "sod","pot","hemo","pcv","wbcc","rbcc")

ckd1 <- ckd_raw %>%
  mutate(across(all_of(num_cols), ~as.numeric(.))) %>%
  mutate(
    rbc   = factor(rbc, levels = c("normal","abnormal")),
    pc    = factor(pc, levels = c("normal","abnormal")),
    pcc   = factor(pcc, levels = c("notpresent","present")),
    ba    = factor(ba,  levels = c("notpresent","present")),
    htn   = factor(htn, levels = c("no","yes")),
    dm    = factor(dm,  levels = c("no","yes")),
    cad   = factor(cad, levels = c("no","yes")),
    appet = factor(appet, levels = c("poor","good")),
    pe    = factor(pe,   levels = c("no","yes")),
    ane   = factor(ane,  levels = c("no","yes")),
    class = factor(class, levels = c("notckd","ckd"))
  )

```

```{r}
colSums(is.na(ckd1))
```

-   I converted numeric-like columns to numeric and standardized categorical columns to consistent factor levels (yes/no, present/notpresent, normal/abnormal, class = notckd/ckd).

-   And then I counted remaining NAs with `colSums(is.na(ckd1))`.

```{r}
# Helper function for categorical mode
Mode <- function(x) {
  x <- x[!is.na(x)]
  if (length(x) == 0) return(NA)
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

```{r}
# Define numeric and categorical columns
num_cols <- c("age","bp","sg","al","su","bgr","bu","sc",
              "sod","pot","hemo","pcv","wbcc","rbcc")

cat_cols <- c("rbc","pc","pcc","ba","htn","dm","cad",
              "appet","pe","ane","class")
```

```{r}
# Impute missing values
ckd_clean <- ckd1 %>%
  # Numeric → median imputation
  mutate(across(all_of(num_cols),
                ~ ifelse(is.na(.), median(., na.rm = TRUE), .))) %>%
  # Categorical → mode imputation
  mutate(across(all_of(cat_cols),
                ~ ifelse(is.na(.), Mode(.), .))) %>%
  # Make sure categorical vars are factors again
  mutate(across(all_of(cat_cols), ~ factor(.)))
```

```{r}
colSums(is.na(ckd_clean))
```

After applying these imputations, I confirmed that the dataset is complete by running `colSums(is.na(ckd_clean))`, which showed **zero missing values** across all 26 variables.

```{r}
# Model 1: Age, Blood Pressure, Serum Creatinine, Hemoglobin
logit1 <- glm(class ~ age + bp + sc + hemo,
              data = ckd_clean, family = "binomial")

summary(logit1)

# Odds ratios
exp(coef(logit1))
```

```{r}
# McFadden's pseudo-R2
pseudoR2 <- function(model) {
  1 - (model$deviance / model$null.deviance)
}

pseudoR2(logit1)  # for Model 1
```

```{r}
library(pROC)
```

```{r}
# Model 1: Predicted probabilities
prob1 <- predict(logit1, type = "response")
roc1 <- roc(ckd_clean$class, prob1)   # ROC curve
auc(roc1)                             # AUC value
plot(roc1, main = "ROC Curve - Logistic Model 1")
```

## **Logistic Model 1**

### Model fit

-   **Residual deviance = 122.86** (vs Null deviance = 528.22) → huge drop, model fits well.

-   **AIC = 132.86** → lower AIC indicates strong fit.

-   **McFadden’s pseudo-R² = 0.767** → excellent explanatory power (above 0.4 is usually very strong).

-   **ROC-AUC = 0.983** → outstanding classification accuracy (close to 1 = near-perfect).

This model used age, blood pressure, serum creatinine, and hemoglobin to predict CKD status. The results show that **serum creatinine** is the strongest predictor, with higher levels dramatically increasing the likelihood of CKD. **Hemoglobin** is also highly significant, where lower values are strongly associated with CKD. **Blood pressure** has a moderate but significant effect, with each unit increase raising the odds of CKD by about 6%. **Age** was not a significant factor in this dataset. Overall, the model fits extremely well, with a **pseudo-R² of 0.77** and an **ROC-AUC of 0.98**, indicating excellent classification accuracy.

```{r}
# Model 2: Hypertension, Diabetes, Coronary Artery Disease, Anemia
logit2 <- glm(class ~ htn + dm + cad + ane,
              data = ckd_clean, family = "binomial")

summary(logit2)

# Odds ratios
exp(coef(logit2))
```

```{r}
# McFadden's pseudo-R2
pseudoR2 <- function(model) {
  1 - (model$deviance / model$null.deviance)
}

pseudoR2(logit2)  # for Model 2
```

```{r}
# Model 2: Predicted probabilities
prob2 <- predict(logit2, type = "response")
roc2 <- roc(ckd_clean$class, prob2)
auc(roc2)
plot(roc2, main = "ROC Curve - Logistic Model 2")
```

## **Logistic Model 2**

### Model fit

-   **Residual deviance = 253.08** (still lower than null deviance = 528.22, so the model explains some variance).

-   **AIC = 263.08** → higher than Model 1 (worse fit).

-   **McFadden’s pseudo-R² = 0.52** → decent explanatory power, but weaker than Model 1 (0.77).

-   **ROC-AUC = 0.879** → good predictive accuracy (but much lower than Model 1’s AUC of 0.983).

    This model used hypertension, diabetes, coronary artery disease, and anemia to predict CKD status. The results show that **none of these comorbidity variables were statistically significant predictors** of CKD in this dataset, with very large standard errors and unstable odds ratios. While these conditions are clinically linked to kidney disease, they did not provide strong predictive power on their own here.

    Despite this, the model performed reasonably well overall, with a **pseudo-R² of 0.52** and an **ROC-AUC of 0.88**, suggesting moderate explanatory strength and good classification accuracy. This indicates that while comorbidities alone are not strong drivers of CKD prediction, they may still contribute useful background information when combined with clinical measures.

```{r}
# Linear regression: Hemoglobin as target
lm_hemo <- lm(hemo ~ age + bp + htn + class, data = ckd_clean)
summary(lm_hemo)
```

```{r}
plot(lm_hemo, which = 1)
```

```{r}
plot(lm_hemo, which = 2)
```

```{r}
library(broom)

tidy(lm_hemo, conf.int = TRUE)
```

```{r}
tidy(lm_hemo, conf.int = TRUE) %>%
  ggplot(aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_pointrange(color = "steelblue") +
  coord_flip() +
  labs(title = "Coefficient Estimates with 95% CI (Linear Model)",
       x = "Predictor", y = "Estimate")

```

```{r}
ggplot(ckd_clean, aes(x = age, y = hemo)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Hemoglobin vs Age with Regression Line")
```

### Linear Regression Model (Hemoglobin Prediction)

-   **Residuals vs Fitted**: points are scattered fairly randomly around zero, but clusters exist , indicating decent fit with some heteroscedasticity.

-   **Q-Q plot**: residuals follow the diagonal line fairly well, meaning errors are approximately normally distributed.

-   **Coefficient plot**: confirms that CKD class and hypertension are the dominant predictors.

-   **Hemoglobin vs Age**: scatterplot with regression line shows only a very weak negative slope, confirming age is not strong predictor.

This model predicted hemoglobin levels using age, blood pressure, hypertension, and CKD class. The results show that **CKD status is the strongest predictor**, with patients diagnosed with CKD having on average **3.2 units lower hemoglobin** than non-CKD individuals. **Hypertension** also has a significant negative effect, reducing hemoglobin by about **1.4 units**. In contrast, **age** and **blood pressure** were not statistically significant predictors in this dataset.

Overall, the model demonstrates a **moderate fit** (Adjusted R² = 0.56), suggesting that over half of the variability in hemoglobin can be explained by these clinical factors. Diagnostic plots confirm that model assumptions are reasonably met. These findings emphasize the clinical relevance of CKD status and hypertension in predicting hemoglobin, both of which are consistent with medical expectations of anemia in CKD patients.
